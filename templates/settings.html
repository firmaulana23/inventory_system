<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - Inventory System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Enhanced mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .grid.md\:grid-cols-2 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .mobile-hidden {
                display: none;
            }
            
            button {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* Focus states for accessibility */
        input:focus, select:focus, button:focus, textarea:focus {
            outline: 2px solid #8b5cf6;
            outline-offset: 2px;
        }
        
        /* Card hover effects */
        .settings-card {
            transition: all 0.3s ease;
        }
        
        .settings-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Button animations */
        .btn-hover {
            transition: all 0.2s ease;
        }
        
        .btn-hover:hover {
            transform: scale(1.02);
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-100">
    <nav class="bg-purple-800 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">
                <i class="fas fa-cog mr-2"></i>System Settings
            </h1>
            <div class="flex items-center space-x-4">
                <span id="user-name" class="text-sm"></span>
                
                <!-- Burger Menu -->
                <div class="relative">
                    <button id="burger-menu" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="dropdown-menu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-50">
                        <div class="py-2">
                            <a href="/admin-dashboard.html" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-tachometer-alt mr-3 text-blue-500"></i>
                                Dashboard
                            </a>
                            <a href="/purchase_orders" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-file-invoice-dollar mr-3 text-purple-500"></i>
                                Manage Purchase
                            </a>
                            <a href="/manage_products" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-boxes mr-3 text-green-500"></i>
                                Manage Products
                            </a>
                            <a href="/sales_history" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-chart-bar mr-3 text-purple-500"></i>
                                Sales History
                            </a>
                            <a href="/contact_supplier" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-address-book mr-3 text-orange-500"></i>
                                Supplier Contacts
                            </a>
                            <a href="/users" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-users mr-3 text-blue-500"></i>
                                Manage Users
                            </a>
                            <button onclick="logout()" class="flex items-center w-full px-4 py-2 text-gray-800 hover:bg-gray-100 text-left">
                                <i class="fas fa-sign-out-alt mr-3"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto p-6">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">System Configuration</h2>
                <p class="text-gray-600 text-sm mt-1">Manage your system settings and preferences</p>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="resetSettings()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors duration-200">
                    <i class="fas fa-undo mr-2"></i>Reset
                </button>
                <button onclick="saveAllSettings()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                    <i class="fas fa-save mr-2"></i>Save All
                </button>
            </div>
        </div>
        
        <!-- Settings Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Company Profile Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 settings-card">
                <div class="flex items-center mb-6">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                        <i class="fas fa-building text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Company Profile</h3>
                        <p class="text-sm text-gray-600">Manage your company information and branding</p>
                    </div>
                </div>
                
                <form id="company-profile-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-image mr-1"></i>Company Logo
                        </label>
                        <div class="flex items-center space-x-4">
                            <div id="logo-preview" class="w-24 h-24 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50">
                                <span class="text-gray-400 text-xs text-center">No logo</span>
                            </div>
                            <div class="flex-1">
                                <input type="file" id="logo-upload" accept="image/*" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200"
                                       onchange="handleLogoUpload()">
                                <p class="text-xs text-gray-500 mt-1">PNG, JPG, or GIF. Max 2MB</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="company-name" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-building mr-1"></i>Company Name *
                            </label>
                            <input type="text" id="company-name" name="company_name" required
                                   placeholder="Enter company name..." 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                        </div>
                        
                        <div>
                            <label for="company-email" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-envelope mr-1"></i>Company Email
                            </label>
                            <input type="email" id="company-email" name="company_email"
                                   placeholder="company@example.com" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                        </div>
                    </div>
                    
                    <div>
                        <label for="company-address" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-1"></i>Company Address
                        </label>
                        <textarea id="company-address" name="company_address" rows="3"
                                  placeholder="Enter complete company address..." 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="company-phone" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-phone mr-1"></i>Company Phone
                            </label>
                            <input type="tel" id="company-phone" name="company_phone"
                                   placeholder="+62 xxx xxxx xxxx" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                        </div>
                        
                        <div>
                            <label for="company-website" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-globe mr-1"></i>Company Website
                            </label>
                            <input type="url" id="company-website" name="company_website"
                                   placeholder="https://company.com" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="tax-number" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-file-invoice mr-1"></i>Tax Number (NPWP)
                            </label>
                            <input type="text" id="tax-number" name="tax_number"
                                   placeholder="xx.xxx.xxx.x-xxx.xxx" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                        </div>
                        
                        <div>
                            <label for="business-license" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-certificate mr-1"></i>Business License
                            </label>
                            <input type="text" id="business-license" name="business_license"
                                   placeholder="Business registration number" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                        </div>
                    </div>
                    
                    <div>
                        <label for="bank-account" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-university mr-1"></i>Bank Account Information
                        </label>
                        <textarea id="bank-account" name="bank_account" rows="2"
                                  placeholder="Bank name, account number, account holder..." 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200"></textarea>
                    </div>
                    
                    <div>
                        <label for="invoice-footer" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-comment mr-1"></i>Invoice Footer Message
                        </label>
                        <input type="text" id="invoice-footer" name="invoice_footer"
                               placeholder="Thank you for your business!" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                    </div>
                    
                    <div>
                        <label for="currency" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-money-bill mr-1"></i>Default Currency
                        </label>
                        <select id="currency" name="currency" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                            <option value="IDR">Indonesian Rupiah (IDR)</option>
                            <option value="USD">US Dollar (USD)</option>
                            <option value="EUR">Euro (EUR)</option>
                            <option value="SGD">Singapore Dollar (SGD)</option>
                            <option value="MYR">Malaysian Ringgit (MYR)</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition-colors duration-200 btn-hover">
                            <i class="fas fa-save mr-2"></i>Save Company Profile
                        </button>
                        <button type="button" onclick="removeLogo()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg transition-colors duration-200">
                            <i class="fas fa-trash mr-1"></i>Remove Logo
                        </button>
                    </div>
                </form>
            </div>

            <!-- System Configuration Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 settings-card">
                <div class="flex items-center mb-6">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <i class="fas fa-cog text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">System Configuration</h3>
                        <p class="text-sm text-gray-600">Configure general system settings</p>
                    </div>
                </div>
                
                <form id="general-settings-form" class="space-y-4">
                    <div>
                        <label for="system-timezone" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clock mr-1"></i>System Timezone
                        </label>
                        <select id="system-timezone" name="timezone" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                            <option value="">Select Timezone</option>
                            <option value="Asia/Jakarta">Asia/Jakarta (WIB)</option>
                            <option value="Asia/Makassar">Asia/Makassar (WITA)</option>
                            <option value="Asia/Jayapura">Asia/Jayapura (WIT)</option>
                            <option value="UTC">UTC</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="date-format" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-1"></i>Date Format
                        </label>
                        <select id="date-format" name="date_format" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="language" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-language mr-1"></i>System Language
                        </label>
                        <select id="language" name="language" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                            <option value="en">English</option>
                            <option value="id">Bahasa Indonesia</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg transition-colors duration-200 btn-hover">
                        <i class="fas fa-save mr-2"></i>Save System Settings
                    </button>
                </form>
            </div>
            
            <!-- Notification Settings Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 settings-card">
                <div class="flex items-center mb-6">
                    <div class="p-3 rounded-full bg-orange-100 text-orange-600 mr-4">
                        <i class="fas fa-bell text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Notifications</h3>
                        <p class="text-sm text-gray-600">Manage your notification preferences</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Low Stock Alerts</label>
                            <p class="text-xs text-gray-500">Get notified when products are running low</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="low-stock-alerts" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Order Notifications</label>
                            <p class="text-xs text-gray-500">Get notified about new orders</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="order-notifications" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Email Reports</label>
                            <p class="text-xs text-gray-500">Receive daily/weekly email reports</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="email-reports" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>
                    
                    <button onclick="saveNotificationSettings()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded-lg transition-colors duration-200 btn-hover">
                        <i class="fas fa-save mr-2"></i>Save Notifications
                    </button>
                </div>
            </div>
            
            <!-- Security Settings Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 settings-card">
                <div class="flex items-center mb-6">
                    <div class="p-3 rounded-full bg-red-100 text-red-600 mr-4">
                        <i class="fas fa-shield-alt text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Security & Backup</h3>
                        <p class="text-sm text-gray-600">Manage security and backup settings</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-key mr-1"></i>Session Timeout (minutes)
                        </label>
                        <select id="session-timeout" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                            <option value="30">30 minutes</option>
                            <option value="60" selected>1 hour</option>
                            <option value="120">2 hours</option>
                            <option value="240">4 hours</option>
                        </select>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Auto Backup</label>
                                <p class="text-xs text-gray-500">Automatically backup data daily</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-backup" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        
                        <button onclick="createBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                            <i class="fas fa-download mr-2"></i>Create Manual Backup
                        </button>
                        
                        <button onclick="saveSecuritySettings()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                            <i class="fas fa-save mr-2"></i>Save Security Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = '/api/v1';
        
        // Utility function for API requests
        async function makeRequest(url, options = {}) {
            const token = localStorage.getItem('token');
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
            
            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });
        }

        // Settings data
        let companyLogo = null;
        let companyProfile = {
            company_name: 'INVENTORY SYSTEM',
            company_address: '',
            company_phone: '',
            company_email: '',
            company_website: '',
            tax_number: '',
            business_license: '',
            logo_base64: '',
            invoice_footer: 'Thank you for your business!',
            bank_account: '',
            currency: 'IDR'
        };
        let settings = {
            system: {
                timezone: 'Asia/Jakarta',
                dateFormat: 'DD/MM/YYYY',
                language: 'en'
            },
            notifications: {
                lowStock: false,
                orders: true,
                emailReports: false
            },
            security: {
                sessionTimeout: 60,
                autoBackup: true
            }
        };

        // Logo handling functions
        function handleLogoUpload() {
            const fileInput = document.getElementById('logo-upload');
            const file = fileInput.files[0];
            
            if (file) {
                // Check file size (2MB limit)
                if (file.size > 2 * 1024 * 1024) {
                    showAlert('File size must be less than 2MB', 'error');
                    fileInput.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    companyLogo = e.target.result;
                    showLogoPreview(companyLogo);
                };
                reader.readAsDataURL(file);
            }
        }

        function showLogoPreview(logoData) {
            const preview = document.getElementById('logo-preview');
            preview.innerHTML = `<img src="${logoData}" alt="Company Logo" class="w-full h-full object-contain rounded">`;
        }

        function removeLogo() {
            companyLogo = null;
            companyProfile.logo_base64 = '';
            document.getElementById('logo-preview').innerHTML = '<span class="text-gray-400 text-xs text-center">No logo</span>';
            document.getElementById('logo-upload').value = '';
            showAlert('Logo removed. Don\'t forget to save the company profile!', 'success');
        }

        // Load company profile from API
        async function loadCompanyProfile() {
            try {
                const response = await makeRequest(`${API_BASE}/admin/company-profile`);
                if (response.ok) {
                    const data = await response.json();
                    companyProfile = data;
                    
                    // Update form fields
                    document.getElementById('company-name').value = data.company_name || '';
                    document.getElementById('company-email').value = data.company_email || '';
                    document.getElementById('company-address').value = data.company_address || '';
                    document.getElementById('company-phone').value = data.company_phone || '';
                    document.getElementById('company-website').value = data.company_website || '';
                    document.getElementById('tax-number').value = data.tax_number || '';
                    document.getElementById('business-license').value = data.business_license || '';
                    document.getElementById('bank-account').value = data.bank_account || '';
                    document.getElementById('invoice-footer').value = data.invoice_footer || 'Thank you for your business!';
                    document.getElementById('currency').value = data.currency || 'IDR';
                    
                    // Show logo if exists
                    if (data.logo_base64) {
                        companyLogo = data.logo_base64;
                        showLogoPreview(data.logo_base64);
                    }
                } else {
                    console.log('No company profile found, using defaults');
                }
            } catch (error) {
                console.error('Error loading company profile:', error);
                showAlert('Error loading company profile. Using defaults.', 'error');
            }
        }

        // Save company profile to API
        async function saveCompanyProfile() {
            try {
                const formData = {
                    company_name: document.getElementById('company-name').value || 'INVENTORY SYSTEM',
                    company_email: document.getElementById('company-email').value,
                    company_address: document.getElementById('company-address').value,
                    company_phone: document.getElementById('company-phone').value,
                    company_website: document.getElementById('company-website').value,
                    tax_number: document.getElementById('tax-number').value,
                    business_license: document.getElementById('business-license').value,
                    bank_account: document.getElementById('bank-account').value,
                    invoice_footer: document.getElementById('invoice-footer').value || 'Thank you for your business!',
                    currency: document.getElementById('currency').value || 'IDR',
                    logo_base64: companyLogo || ''
                };
                
                const response = await makeRequest(`${API_BASE}/admin/company-profile`, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    companyProfile = result.data;
                    showAlert('Company profile saved successfully!', 'success');
                } else {
                    const error = await response.json();
                    showAlert(`Error saving company profile: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('Error saving company profile:', error);
                showAlert('Error saving company profile. Please try again.', 'error');
            }
        }

        // General settings functions
        function loadGeneralSettings() {
            const savedSettings = localStorage.getItem('systemSettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }
            
            // Update form fields
            document.getElementById('system-timezone').value = settings.system.timezone;
            document.getElementById('date-format').value = settings.system.dateFormat;
            document.getElementById('language').value = settings.system.language;
        }

        // Notification settings functions
        function loadNotificationSettings() {
            document.getElementById('low-stock-alerts').checked = settings.notifications.lowStock;
            document.getElementById('order-notifications').checked = settings.notifications.orders;
            document.getElementById('email-reports').checked = settings.notifications.emailReports;
        }

        function saveNotificationSettings() {
            settings.notifications = {
                lowStock: document.getElementById('low-stock-alerts').checked,
                orders: document.getElementById('order-notifications').checked,
                emailReports: document.getElementById('email-reports').checked
            };
            
            localStorage.setItem('systemSettings', JSON.stringify(settings));
            showAlert('Notification settings saved successfully!', 'success');
        }

        // Security settings functions
        function loadSecuritySettings() {
            document.getElementById('session-timeout').value = settings.security.sessionTimeout;
            document.getElementById('auto-backup').checked = settings.security.autoBackup;
        }

        function saveSecuritySettings() {
            settings.security = {
                sessionTimeout: parseInt(document.getElementById('session-timeout').value),
                autoBackup: document.getElementById('auto-backup').checked
            };
            
            localStorage.setItem('systemSettings', JSON.stringify(settings));
            showAlert('Security settings saved successfully!', 'success');
        }

        function createBackup() {
            // Simulate backup creation
            const backupData = {
                settings: settings,
                companyProfile: companyProfile,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('Backup created and downloaded successfully!', 'success');
        }

        // Global settings functions
        async function saveAllSettings() {
            // Save company profile first
            await saveCompanyProfile();
            
            // Save system settings
            settings.system = {
                timezone: document.getElementById('system-timezone').value,
                dateFormat: document.getElementById('date-format').value,
                language: document.getElementById('language').value
            };
            
            // Save notification settings
            settings.notifications = {
                lowStock: document.getElementById('low-stock-alerts').checked,
                orders: document.getElementById('order-notifications').checked,
                emailReports: document.getElementById('email-reports').checked
            };
            
            // Save security settings
            settings.security = {
                sessionTimeout: parseInt(document.getElementById('session-timeout').value),
                autoBackup: document.getElementById('auto-backup').checked
            };
            
            // Save to localStorage
            localStorage.setItem('systemSettings', JSON.stringify(settings));
            
            showAlert('All settings saved successfully!', 'success');
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default values? This action cannot be undone.')) {
                // Reset to default values
                settings = {
                    system: {
                        timezone: 'Asia/Jakarta',
                        dateFormat: 'DD/MM/YYYY',
                        language: 'en'
                    },
                    notifications: {
                        lowStock: false,
                        orders: true,
                        emailReports: false
                    },
                    security: {
                        sessionTimeout: 60,
                        autoBackup: true
                    }
                };
                
                // Reset company profile
                companyLogo = null;
                companyProfile = {
                    company_name: 'INVENTORY SYSTEM',
                    company_address: '',
                    company_phone: '',
                    company_email: '',
                    company_website: '',
                    tax_number: '',
                    business_license: '',
                    logo_base64: '',
                    invoice_footer: 'Thank you for your business!',
                    bank_account: '',
                    currency: 'IDR'
                };
                
                // Clear localStorage
                localStorage.removeItem('systemSettings');
                
                // Reload the page to reset all form values
                location.reload();
            }
        }

        // Alert function
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 max-w-md z-50 p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : 
                'bg-red-100 border border-red-400 text-red-700'
            }`;
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (document.body.contains(alertDiv)) {
                    document.body.removeChild(alertDiv);
                }
            }, 3000);
        }


        // Initialize burger menu functionality
        function initializeBurgerMenu() {
            const burgerButton = document.getElementById('burger-menu');
            const dropdownMenu = document.getElementById('dropdown-menu');
            
            if (!burgerButton || !dropdownMenu) return;
            
            // Toggle dropdown on burger button click
            burgerButton.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownMenu.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!dropdownMenu.contains(e.target) && !burgerButton.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });
            
            // Close dropdown when pressing Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdownMenu.classList.add('hidden');
                }
            });
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        // Initialize settings page
        document.addEventListener('DOMContentLoaded', async function() {
            // Set user name if available
            const userInfo = JSON.parse(localStorage.getItem('user') || '{}');
            if (userInfo.name) {
                document.getElementById('user-name').textContent = userInfo.name;
            }
            
            // Initialize burger menu
            initializeBurgerMenu();
            
            // Load all settings
            await loadCompanyProfile();
            loadGeneralSettings();
            loadNotificationSettings();
            loadSecuritySettings();
            
            // Handle company profile form submission
            document.getElementById('company-profile-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveCompanyProfile();
            });
            
            // Handle general settings form submission
            document.getElementById('general-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                settings.system = {
                    timezone: document.getElementById('system-timezone').value,
                    dateFormat: document.getElementById('date-format').value,
                    language: document.getElementById('language').value
                };
                
                localStorage.setItem('systemSettings', JSON.stringify(settings));
                showAlert('System settings saved successfully!', 'success');
            });
        });
    </script>
</body>
</html>
