<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales History - Inventory System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            border-color: #a855f7 !important;
            color: #a855f7 !important;
        }
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Enhanced mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            /* Stack filters vertically on mobile */
            .grid.md\:grid-cols-4 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Improve table responsiveness */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Hide less important columns on mobile in compact view */
            .mobile-hidden {
                display: none;
            }
            
            /* Adjust button sizes for touch */
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Stack summary cards on mobile */
            .grid.md\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Improve modal responsiveness */
            .modal-content {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }
        }
        
        @media (max-width: 480px) {
            /* Single column layout for very small screens */
            .grid.md\:grid-cols-4 {
                grid-template-columns: 1fr;
            }
            
            /* Smaller text on mobile */
            .text-2xl {
                font-size: 1.5rem;
            }
            
            /* Compact navigation */
            nav .container {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
        
        /* Focus states for accessibility */
        input:focus, select:focus, button:focus {
            outline: 2px solid #a855f7;
            outline-offset: 2px;
        }
        
        /* Loading animation improvements */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-purple-800 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">
                <i class="fas fa-chart-bar mr-2"></i>Sales Reports & History
            </h1>
            <div class="flex items-center space-x-4">
                <span id="user-name" class="text-sm"></span>
                
                <!-- Burger Menu -->
                <div class="relative">
                    <button id="burger-menu" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="dropdown-menu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-50">
                        <div class="py-2">
                            <a href="/admin-dashboard.html" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-tachometer-alt mr-3 text-blue-500"></i>
                                Dashboard
                            </a>
                            <a href="/manage_products" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-boxes mr-3 text-green-500"></i>
                                Manage Products
                            </a>
                            <a href="/purchase_orders" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-file-invoice-dollar mr-3 text-red-500"></i>
                                Manage Purchase
                            </a>
                            <a href="/contact_supplier" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-address-book mr-3 text-orange-500"></i>
                                Supplier Contacts
                            </a>
                            <a href="/users" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-users mr-3 text-blue-500"></i>
                                Manage Users
                            </a>
                            <a href="/settings" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100">
                                <i class="fas fa-cog mr-3 text-gray-500"></i>
                                System Settings
                            </a>
                            <button onclick="logout()" class="flex items-center w-full px-4 py-2 text-gray-800 hover:bg-gray-100 text-left">
                                <i class="fas fa-sign-out-alt mr-3"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div class="container mx-auto p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Sales Records & Reports</h2>
            <div class="flex space-x-2">
                <!-- Export Dropdown -->
                <div class="relative">
                    <button id="export-button" onclick="toggleExportMenu()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded flex items-center">
                        <i class="fas fa-download mr-1"></i>Export
                        <i class="fas fa-chevron-down ml-1 text-xs"></i>
                    </button>
                    <div id="export-menu" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-md shadow-lg z-50 border">
                        <div class="p-3 border-b border-gray-200">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Export Date Range</h4>
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">From</label>
                                    <input type="date" id="export-start-date" 
                                           class="w-full text-xs p-2 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">To</label>
                                    <input type="date" id="export-end-date" 
                                           class="w-full text-xs p-2 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <button onclick="setExportDateRange('today')" class="text-xs text-indigo-600 hover:text-indigo-800">Today</button>
                                <button onclick="setExportDateRange('week')" class="text-xs text-indigo-600 hover:text-indigo-800">This Week</button>
                                <button onclick="setExportDateRange('month')" class="text-xs text-indigo-600 hover:text-indigo-800">This Month</button>
                                <button onclick="setExportDateRange('all')" class="text-xs text-indigo-600 hover:text-indigo-800">All Time</button>
                            </div>
                        </div>
                        <div class="px-3 py-2 bg-gray-50 border-b border-gray-200">
                            <div class="text-xs text-gray-600 mb-2">Quick Export (current filters)</div>
                            <div class="flex space-x-1">
                                <button onclick="quickExport('csv')" class="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded transition-colors">
                                    <i class="fas fa-file-csv mr-1"></i>CSV
                                </button>
                                <button onclick="quickExport('excel')" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs px-2 py-1 rounded transition-colors">
                                    <i class="fas fa-file-excel mr-1"></i>Excel
                                </button>
                            </div>
                        </div>
                        <div class="py-1">
                            <button onclick="exportSalesData('csv')" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-file-csv mr-3 text-green-500"></i>
                                Export as CSV (custom range)
                            </button>
                            <button onclick="exportSalesData('excel')" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-file-excel mr-3 text-green-600"></i>
                                Export as Excel (custom range)
                            </button>
                        </div>
                    </div>
                </div>
                <button onclick="refreshCurrentView()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-refresh mr-1"></i>Refresh
                </button>
            </div>
        </div>


        <!-- Sales Content -->
            <!-- Enhanced Search and Filters -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <!-- Quick Search Bar -->
                <div class="p-4 border-b border-gray-200">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="search-filter" 
                               placeholder="Quick search by sale number, customer name, or cashier..." 
                               onkeyup="handleQuickSearch(event)" 
                               class="w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <button onclick="clearSearch()" id="clear-search" class="text-gray-400 hover:text-gray-600 hidden">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Filters (Collapsible) -->
                <div class="p-4">
                    <button onclick="toggleAdvancedFilters()" class="flex items-center justify-between w-full text-left text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors duration-200">
                        <span><i class="fas fa-filter mr-2"></i>Advanced Filters</span>
                        <i id="filter-toggle-icon" class="fas fa-chevron-down transform transition-transform duration-200"></i>
                    </button>
                    
                    <div id="advanced-filters" class="hidden mt-4 pt-4 border-t border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-1 text-gray-400"></i>Date Range
                                </label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="date" id="start-date-filter" 
                                           onchange="filterSales()"
                                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200"
                                           title="Start Date">
                                    <input type="date" id="end-date-filter" 
                                           onchange="filterSales()"
                                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200"
                                           title="End Date">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-credit-card mr-1 text-gray-400"></i>Payment Status
                                </label>
                                <select id="payment-status-filter" onchange="filterSales()" 
                                        class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                                    <option value="">All Statuses</option>
                                    <option value="paid">✅ Paid</option>
                                    <option value="pending">⏳ Pending</option>
                                    <option value="overdue">⚠️ Overdue</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-money-bill mr-1 text-gray-400"></i>Payment Method
                                </label>
                                <select id="payment-filter" onchange="filterSales()" 
                                        class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                                    <option value="">All Methods</option>
                                    <option value="cash">💰 Cash</option>
                                    <option value="card">💳 Card</option>
                                    <option value="transfer">🏦 Transfer</option>
                                    <option value="credit">📝 Credit</option>
                                    <option value="qris">📱 QRIS</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-dollar-sign mr-1 text-gray-400"></i>Amount Range
                                </label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="min-amount-filter" 
                                           placeholder="Min Rp" onchange="filterSales()" oninput="filterSales()"
                                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                                    <input type="number" id="max-amount-filter" 
                                           placeholder="Max Rp" onchange="filterSales()" oninput="filterSales()"
                                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                            <div class="text-sm text-gray-600">
                                <span id="active-filters-count">0</span> filters active
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="applyFilters()" 
                                        class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition-all duration-200 transform hover:scale-105 flex items-center">
                                    <i class="fas fa-search mr-2"></i>Apply Filters
                                </button>
                                <button onclick="clearAllFilters()" 
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-all duration-200 transform hover:scale-105 flex items-center">
                                    <i class="fas fa-eraser mr-2"></i>Clear All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Sales Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-500">
                        <i class="fas fa-chart-line text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Sales</p>
                        <p id="total-sales" class="text-2xl font-semibold text-gray-900">Rp0.00</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                        <i class="fas fa-receipt text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                        <p id="total-transactions" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-500">
                        <i class="fas fa-clock text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Pending Payments</p>
                        <p id="pending-payments" class="text-2xl font-semibold text-gray-900">Rp0.00</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Overdue</p>
                        <p id="overdue-payments" class="text-2xl font-semibold text-gray-900">Rp0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Table Container -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <!-- Table Header with Controls -->
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Sales Records</h3>
                        <p class="text-sm text-gray-600 mt-1">
                            <span id="total-records">0</span> records found
                            <span id="filtered-info" class="hidden"> (filtered from <span id="original-total">0</span> total)</span>
                        </p>
                    </div>
                    <div class="mt-3 sm:mt-0 flex items-center space-x-3">
                        <!-- View Toggle -->
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button onclick="setTableView('compact')" id="compact-view" 
                                    class="px-3 py-1 text-sm rounded-md transition-all duration-200 bg-white text-gray-900 shadow-sm">
                                <i class="fas fa-list mr-1"></i>Compact
                            </button>
                            <button onclick="setTableView('detailed')" id="detailed-view" 
                                    class="px-3 py-1 text-sm rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900">
                                <i class="fas fa-th-large mr-1"></i>Detailed
                            </button>
                        </div>
                        
                        <!-- Sort Options -->
                        <select id="sort-select" onchange="handleSort()" 
                                class="text-sm border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="created_at-desc">Latest First</option>
                            <option value="created_at-asc">Oldest First</option>
                            <option value="total-desc">Highest Amount</option>
                            <option value="total-asc">Lowest Amount</option>
                            <option value="sale_number-asc">Sale Number</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="table-loading" class="hidden flex items-center justify-center py-12">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mb-3"></div>
                    <p class="text-gray-600">Loading sales data...</p>
                </div>
            </div>
            
            <!-- Table Container -->
            <div id="table-container" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors duration-150" onclick="sortBy('sale_number')">
                                Sale Number
                                <i id="sort-sale_number" class="fas fa-sort ml-1 text-gray-400"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors duration-150" onclick="sortBy('customer_name')">
                                Customer
                                <i id="sort-customer_name" class="fas fa-sort ml-1 text-gray-400"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors duration-150" onclick="sortBy('created_at')">
                                Date
                                <i id="sort-created_at" class="fas fa-sort-down ml-1 text-purple-600"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Payment Method
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors duration-150" onclick="sortBy('payment_status')">
                                Payment Status
                                <i id="sort-payment_status" class="fas fa-sort ml-1 text-gray-400"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors duration-150" onclick="sortBy('total')">
                                Total
                                <i id="sort-total" class="fas fa-sort ml-1 text-gray-400"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Cashier
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Sales rows will be injected here by JS -->
                    </tbody>
                </table>
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-12">
                <div class="text-gray-400 mb-4">
                    <i class="fas fa-receipt text-6xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No sales records found</h3>
                <p class="text-gray-600 mb-6">Try adjusting your search criteria or date range.</p>
                <button onclick="clearAllFilters()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition-colors duration-200">
                    Clear All Filters
                </button>
            </div>
        </div>
        
            <!-- Pagination -->
            <div id="pagination" class="mt-4 flex justify-center space-x-2">
                <!-- Pagination buttons will be added here -->
            </div>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="record-payment-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-6 border w-96 shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-800">Record Payment</h3>
                    <p class="text-sm text-gray-600">Add a payment for this credit sale</p>
                </div>
                <button onclick="closeRecordPayment()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-money-bill-wave mr-1"></i>Payment Amount
                    </label>
                    <input type="number" id="payment-amount" 
                           class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                           min="0" step="0.01" placeholder="Enter payment amount">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-credit-card mr-1"></i>Payment Method
                    </label>
                    <select id="payment-method-select" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="cash">💰 Cash</option>
                        <option value="card">💳 Card</option>
                        <option value="transfer">🏦 Transfer</option>
                        <option value="qris">📱 QRIS</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-sticky-note mr-1"></i>Notes (Optional)
                    </label>
                    <textarea id="payment-notes" 
                              class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                              rows="3" placeholder="Add any notes about this payment..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="closeRecordPayment()" 
                            class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                        Cancel
                    </button>
                    <button onclick="submitPayment()" 
                            class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition flex items-center">
                        <i class="fas fa-check mr-2"></i>Record Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History Modal -->
    <div id="payment-history-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-6 border w-11/12 max-w-4xl shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-800">Payment History</h3>
                    <p class="text-sm text-gray-600">Complete payment history for this credit sale</p>
                </div>
                <button onclick="closePaymentHistory()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="bg-white rounded-lg border overflow-hidden">
                <div id="payment-history-content">
                    <!-- Payment history will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const API_BASE = '/api/v1';
        const token = localStorage.getItem('token');

        // Check authentication
        if (!token) {
            window.location.href = '/login.html';
        }

        // Format number function
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        // Set authorization header for all requests
        function makeRequest(url, options = {}) {
            return fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
        }

        // Fetch and display sales
        async function fetchSales(filters = {}) {
            try {
                let url = `${API_BASE}/pos/sales?limit=100`;
                
                // Add all filters to URL (backend support)
                if (filters.start_date) url += `&start_date=${filters.start_date}`;
                if (filters.end_date) url += `&end_date=${filters.end_date}`;
                if (filters.payment_method) url += `&payment_method=${filters.payment_method}`;
                if (filters.payment_status) url += `&payment_status=${filters.payment_status}`;
                if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;
                if (filters.min_amount) url += `&min_amount=${filters.min_amount}`;
                if (filters.max_amount) url += `&max_amount=${filters.max_amount}`;

                const response = await makeRequest(url);
                if (!response.ok) {
                    if (response.status === 403) {
                        alert('Access denied. Please check your permissions.');
                        return;
                    } else if (response.status === 401) {
                        alert('Session expired. Please login again.');
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error('Failed to fetch sales');
                }

                const data = await response.json();
                
                // Apply client-side filtering as backup if backend doesn't support all filters
                let salesData = data.sales || [];
                salesData = applyClientSideFilters(salesData, filters);
                
                displaySales(salesData);
            } catch (error) {
                console.error('Error fetching sales:', error);
                alert('Failed to load sales history: ' + error.message);
            }
        }

        // Client-side filtering as backup for unsupported backend filters
        function applyClientSideFilters(sales, filters) {
            return sales.filter(sale => {
                // Search filter (searches in sale number, customer name, and cashier name)
                if (filters.search && filters.search.trim() !== '') {
                    const searchTerm = filters.search.toLowerCase().trim();
                    const saleNumber = (sale.sale_number || sale.id.toString()).toLowerCase();
                    const customerName = (sale.customer_name || '').toLowerCase();
                    const cashierName = (sale.user?.name || '').toLowerCase();
                    
                    if (!saleNumber.includes(searchTerm) && 
                        !customerName.includes(searchTerm) && 
                        !cashierName.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Payment status filter
                if (filters.payment_status && filters.payment_status !== '') {
                    const salePaymentStatus = determinePaymentStatus(sale);
                    if (salePaymentStatus !== filters.payment_status) {
                        return false;
                    }
                }
                
                // Amount range filter
                if (filters.min_amount && filters.min_amount !== '') {
                    const minAmount = parseFloat(filters.min_amount);
                    if (sale.total < minAmount) {
                        return false;
                    }
                }
                
                if (filters.max_amount && filters.max_amount !== '') {
                    const maxAmount = parseFloat(filters.max_amount);
                    if (sale.total > maxAmount) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        // Determine payment status based on sale data
        function determinePaymentStatus(sale) {
            // If payment_status is explicitly set, use it
            if (sale.payment_status) {
                return sale.payment_status;
            }
            
            // For credit sales, determine status based on amount due and due date
            if (sale.payment_method === 'credit') {
                // Check for amount due (could be amount_due or amountDue)
                const amountDue = sale.amount_due || sale.amountDue || 0;
                
                if (amountDue > 0) {
                    // Check if overdue
                    const dueDate = sale.due_date || sale.dueDate;
                    if (dueDate && new Date(dueDate) < new Date()) {
                        return 'overdue';
                    }
                    return 'pending';
                } else {
                    return 'paid';
                }
            }
            
            // For non-credit sales, default to paid
            return 'paid';
        }

        // Apply filters with enhanced UX
        function applyFilters() {
            showLoading();
            
            const filters = {
                start_date: document.getElementById('start-date-filter').value,
                end_date: document.getElementById('end-date-filter').value,
                payment_method: document.getElementById('payment-filter').value,
                payment_status: document.getElementById('payment-status-filter').value,
                search: document.getElementById('search-filter').value,
                min_amount: document.getElementById('min-amount-filter').value,
                max_amount: document.getElementById('max-amount-filter').value
            };
            
            
            // Update active filters count
            updateActiveFiltersCount(filters);
            
            fetchSales(filters);
            loadSalesSummary(); // Refresh summary with current filters
        }

        // Update active filters count
        function updateActiveFiltersCount(filters) {
            let count = 0;
            Object.entries(filters).forEach(([key, value]) => {
                if (value && value !== '') {
                    count++;
                }
            });
            document.getElementById('active-filters-count').textContent = count;
        }

        // Refresh sales
        function refreshSales() {
            applyFilters();
        }

        // Set default dates (last 30 days)
        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('end-date-filter').value = today.toISOString().split('T')[0];
            document.getElementById('start-date-filter').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Enhanced display sales with UX improvements
        function displaySales(sales, originalTotal = null) {
            hideLoading();
            
            const tbody = document.getElementById('sales-table-body');
            tbody.innerHTML = '';
            
            // Update record counts
            document.getElementById('total-records').textContent = sales.length;
            if (originalTotal && originalTotal !== sales.length) {
                document.getElementById('filtered-info').classList.remove('hidden');
                document.getElementById('original-total').textContent = originalTotal;
            } else {
                document.getElementById('filtered-info').classList.add('hidden');
            }

            if (sales.length === 0) {
                showEmptyState();
                return;
            }

            // Sort sales based on current sort
            const sortedSales = [...sales].sort((a, b) => {
                let aVal = a[currentSort.field];
                let bVal = b[currentSort.field];
                
                // Handle different data types
                if (currentSort.field === 'created_at') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (currentSort.field === 'total') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            sortedSales.forEach((sale, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 border-b border-gray-100 transition-colors duration-150';
                
                // Get payment status badge
                const paymentStatus = determinePaymentStatus(sale);
                const statusBadge = getStatusBadge(paymentStatus);
                
                // Enhanced row with better styling and interactions
                if (currentView === 'compact') {
                    row.innerHTML = `
                        <td class="px-6 py-3 text-sm font-medium">
                            <div class="flex items-center">
                                <span class="text-gray-900">${sale.sale_number || '#' + sale.id}</span>
                                ${paymentStatus === 'overdue' ? '<i class="fas fa-exclamation-triangle text-red-500 ml-2" title="Overdue"></i>' : ''}
                            </div>
                        </td>
                        <td class="px-6 py-3 text-sm">
                            <div class="flex items-center">
                                <i class="fas fa-user text-gray-400 mr-2"></i>
                                ${sale.customer_name || '<span class="text-gray-400">Walk-in</span>'}
                            </div>
                        </td>
                        <td class="px-6 py-3 text-sm text-gray-600">${formatDate(sale.created_at)}</td>
                        <td class="px-6 py-3 text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                                <i class="fas fa-${getPaymentIcon(sale.payment_method)} mr-1"></i>
                                ${(sale.payment_method || 'cash').charAt(0).toUpperCase() + (sale.payment_method || 'cash').slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-3">${statusBadge}</td>
                        <td class="px-6 py-3 text-sm font-semibold text-green-600">Rp${sale.total}</td>
                        <td class="px-6 py-3 text-sm text-gray-600">${sale.user ? sale.user.name : 'Unknown'}</td>
                        <td class="px-6 py-3 text-right">
                            <div class="flex items-center justify-end space-x-2">
                                <button onclick="viewSaleDetails(${sale.id})" 
                                        class="inline-flex items-center px-2.5 py-1.5 text-xs font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 transition-colors duration-150"
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${(paymentStatus === 'pending' || paymentStatus === 'overdue') && sale.payment_method === 'credit' ? `
                                    <button onclick="showRecordPayment(${sale.id}, ${sale.amount_due || 0})" 
                                            class="inline-flex items-center px-2.5 py-1.5 text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 transition-colors duration-150"
                                            title="Record Payment">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                ` : ''}
                                <button onclick="deleteSale(${sale.id}, '${sale.sale_number || sale.id}')" 
                                        class="inline-flex items-center px-2.5 py-1.5 text-xs font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 transition-colors duration-150"
                                        title="Delete Sale">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                } else {
                    // Detailed view with more information
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm">
                            <div class="flex flex-col">
                                <span class="font-medium text-gray-900">${sale.sale_number || '#' + sale.id}</span>
                                <span class="text-xs text-gray-500">ID: ${sale.id}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8">
                                    <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                                        <i class="fas fa-user text-gray-500 text-xs"></i>
                                    </div>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900">${sale.customer_name || 'Walk-in Customer'}</p>
                                    <p class="text-xs text-gray-500">Customer</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex flex-col">
                                <span class="text-gray-900">${formatDate(sale.created_at)}</span>
                                <span class="text-xs text-gray-500">${formatTime(sale.created_at)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <span class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                                <i class="fas fa-${getPaymentIcon(sale.payment_method)} mr-2"></i>
                                ${(sale.payment_method || 'cash').charAt(0).toUpperCase() + (sale.payment_method || 'cash').slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4">
                            <div class="flex flex-col">
                                <span class="text-sm font-semibold text-green-600">Rp${sale.total}</span>
                                ${sale.payment_method === 'credit' && sale.amount_due > 0 ? 
                                    `<span class="text-xs text-red-600">Due: Rp${sale.amount_due}</span>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-6 w-6">
                                    <div class="h-6 w-6 rounded-full bg-purple-100 flex items-center justify-center">
                                        <i class="fas fa-user-tie text-purple-600 text-xs"></i>
                                    </div>
                                </div>
                                <span class="ml-2 text-gray-900">${sale.user ? sale.user.name : 'Unknown'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end space-x-1">
                                <button onclick="viewSaleDetails(${sale.id})" 
                                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 transition-colors duration-150">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                                ${(paymentStatus === 'pending' || paymentStatus === 'overdue') && sale.payment_method === 'credit' ? `
                                    <button onclick="showRecordPayment(${sale.id}, ${sale.amount_due || 0})" 
                                            class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 transition-colors duration-150">
                                        <i class="fas fa-plus mr-1"></i>Pay
                                    </button>
                                ` : ''}
                                <button onclick="deleteSale(${sale.id}, '${sale.sale_number || sale.id}')" 
                                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 transition-colors duration-150">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </td>
                    `;
                }
                
                // Add row animation
                row.style.opacity = '0';
                row.style.transform = 'translateY(10px)';
                tbody.appendChild(row);
                
                // Trigger animation
                setTimeout(() => {
                    row.style.transition = 'all 0.3s ease-out';
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0)';
                }, index * 50);
            });
        }

        // Helper function for payment method icons
        function getPaymentIcon(method) {
            const icons = {
                'cash': 'money-bill-wave',
                'card': 'credit-card',
                'transfer': 'university',
                'credit': 'file-invoice',
                'qris': 'qrcode'
            };
            return icons[method] || 'money-bill-wave';
        }

        // Helper function to format time
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        // Delete sale function
        async function deleteSale(saleId, saleNumber) {
            // Confirmation dialog
            if (!confirm(`Are you sure you want to delete sale ${saleNumber}?\n\nThis action cannot be undone and will:\n- Remove the sale record\n- Restore product stock quantities\n- Remove all associated sale items`)) {
                return;
            }

            try {
                const response = await makeRequest(`${API_BASE}/pos/sales/${saleId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert(`Sale ${saleNumber} deleted successfully!`);
                    // Refresh the sales list
                    applyFilters();
                } else if (response.status === 403) {
                    alert('Access denied. You do not have permission to delete sales.');
                } else if (response.status === 401) {
                    alert('Session expired. Please login again.');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                } else if (response.status === 404) {
                    alert('Sale not found. It may have already been deleted.');
                    applyFilters(); // Refresh to update the list
                } else {
                    const error = await response.json();
                    alert(`Failed to delete sale: ${error.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting sale:', error);
                alert('Failed to delete sale: Network error');
            }
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Initialize burger menu functionality
        function initializeBurgerMenu() {
            const burgerButton = document.getElementById('burger-menu');
            const dropdownMenu = document.getElementById('dropdown-menu');
            
            // Toggle dropdown on burger button click
            burgerButton.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownMenu.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!dropdownMenu.contains(e.target) && !burgerButton.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });
            
            // Close dropdown when pressing Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdownMenu.classList.add('hidden');
                }
            });
        }

        // Toggle export menu
        function toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('hidden');
            
            // Initialize export date range with current filter values
            if (!menu.classList.contains('hidden')) {
                syncExportDatesWithFilters();
            }
        }
        
        // Sync export dates with current filter dates
        function syncExportDatesWithFilters() {
            const startDate = document.getElementById('start-date-filter').value;
            const endDate = document.getElementById('end-date-filter').value;
            
            document.getElementById('export-start-date').value = startDate;
            document.getElementById('export-end-date').value = endDate;
        }
        
        // Set export date range with preset options
        function setExportDateRange(range) {
            const today = new Date();
            let startDate, endDate;
            
            switch(range) {
                case 'today':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
                    startDate = weekStart.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    startDate = monthStart.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'all':
                    startDate = '';
                    endDate = '';
                    break;
            }
            
            document.getElementById('export-start-date').value = startDate;
            document.getElementById('export-end-date').value = endDate;
        }
        
        // Quick export using current filter dates
        async function quickExport(format) {
            // Set export dates to current filter dates
            syncExportDatesWithFilters();
            
            // Call regular export function
            await exportSalesData(format);
        }
        
        // Close export menu when clicking outside
        document.addEventListener('click', function(event) {
            const exportButton = document.getElementById('export-button');
            const exportMenu = document.getElementById('export-menu');
            
            if (!exportButton.contains(event.target) && !exportMenu.contains(event.target)) {
                exportMenu.classList.add('hidden');
            }
        });

        // Export sales data with format selection
        async function exportSalesData(format = 'csv') {
            try {
                // Get export-specific date range (not filter dates)
                const exportStartDate = document.getElementById('export-start-date').value;
                const exportEndDate = document.getElementById('export-end-date').value;
                
                // Validate date range
                if (exportStartDate && exportEndDate && exportStartDate > exportEndDate) {
                    alert('Start date cannot be later than end date');
                    return;
                }
                
                // Show confirmation for large date ranges
                if (!exportStartDate && !exportEndDate) {
                    if (!confirm('You are about to export all sales data. This may take a while and result in a large file. Continue?')) {
                        return;
                    }
                }
                
                // Hide the export menu
                document.getElementById('export-menu').classList.add('hidden');
                
                // Show progress indicator
                const exportButton = document.getElementById('export-button');
                const originalText = exportButton.innerHTML;
                exportButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Exporting...';
                exportButton.disabled = true;
                
                // Get additional filters (payment method and status)
                const paymentMethod = document.getElementById('payment-filter').value;
                const paymentStatus = document.getElementById('payment-status-filter').value;
                
                // Determine the endpoint based on format
                let exportUrl = format === 'excel' ? 
                    `${API_BASE}/pos/sales/export-excel?` : 
                    `${API_BASE}/pos/sales/export?`;
                    
                if (exportStartDate) exportUrl += `start_date=${exportStartDate}&`;
                if (exportEndDate) exportUrl += `end_date=${exportEndDate}&`;
                if (paymentMethod) exportUrl += `payment_method=${paymentMethod}&`;
                if (paymentStatus) exportUrl += `payment_status=${paymentStatus}&`;
                
                // Use fetch with authentication headers
                const response = await fetch(exportUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Session expired. Please login again.');
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    } else if (response.status === 403) {
                        alert('Access denied. You do not have permission to export sales data.');
                        return;
                    } else {
                        throw new Error(`Export failed: ${response.status}`);
                    }
                }
                
                // Get the file content (CSV text or Excel binary)
                let blob;
                let filename;
                let fileExtension;
                
                if (format === 'excel') {
                    const arrayBuffer = await response.arrayBuffer();
                    blob = new Blob([arrayBuffer], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });
                    fileExtension = 'xlsx';
                } else {
                    const csvContent = await response.text();
                    blob = new Blob([csvContent], { type: 'text/csv' });
                    fileExtension = 'csv';
                }
                
                filename = `sales_report_${new Date().toISOString().split('T')[0]}.${fileExtension}`;
                
                // Create download
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the blob URL
                window.URL.revokeObjectURL(url);
                
                // Generate descriptive filename with date range
                let dateRangeText = '';
                if (exportStartDate && exportEndDate) {
                    if (exportStartDate === exportEndDate) {
                        dateRangeText = `_${exportStartDate}`;
                    } else {
                        dateRangeText = `_${exportStartDate}_to_${exportEndDate}`;
                    }
                } else if (exportStartDate) {
                    dateRangeText = `_from_${exportStartDate}`;
                } else if (exportEndDate) {
                    dateRangeText = `_until_${exportEndDate}`;
                } else {
                    dateRangeText = `_all_time`;
                }
                
                filename = `sales_report${dateRangeText}.${fileExtension}`;
                
                // Show success message with details
                const dateRangeDisplay = exportStartDate && exportEndDate 
                    ? ` for ${exportStartDate} to ${exportEndDate}` 
                    : exportStartDate 
                        ? ` from ${exportStartDate}` 
                        : exportEndDate 
                            ? ` until ${exportEndDate}` 
                            : ' (all time)';
                            
                alert(`Sales report exported successfully as ${format.toUpperCase()}${dateRangeDisplay}!`);
                
            } catch (error) {
                console.error('Error exporting sales data:', error);
                alert('Failed to export sales data: ' + error.message);
            } finally {
                // Reset export button
                const exportButton = document.getElementById('export-button');
                exportButton.innerHTML = '<i class="fas fa-download mr-1"></i>Export<i class="fas fa-chevron-down ml-1 text-xs"></i>';
                exportButton.disabled = false;
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('start-date-filter').value = '';
            document.getElementById('end-date-filter').value = '';
            document.getElementById('payment-filter').value = '';
            document.getElementById('payment-status-filter').value = '';
            document.getElementById('search-filter').value = '';
            
            // Reload data with cleared filters
            applyFilters();
        }

        // UX Enhancement Variables
        let currentSort = { field: 'created_at', direction: 'desc' };
        let currentView = 'compact';
        let isLoading = false;
        
        // Enhanced filter function with real-time search
        function filterSales() {
            // Debounce the filter function to avoid too many API calls
            clearTimeout(filterSales.timeout);
            filterSales.timeout = setTimeout(applyFilters, 300);
        }

        // Quick search with better UX
        function handleQuickSearch(event) {
            const searchTerm = event.target.value;
            const clearButton = document.getElementById('clear-search');
            
            // Show/hide clear button
            if (searchTerm.length > 0) {
                clearButton.classList.remove('hidden');
            } else {
                clearButton.classList.add('hidden');
            }
            
            // Trigger search with debounce
            clearTimeout(handleQuickSearch.timeout);
            handleQuickSearch.timeout = setTimeout(() => {
                filterSales();
            }, 300);
            
            // Enter key to search immediately
            if (event.key === 'Enter') {
                clearTimeout(handleQuickSearch.timeout);
                applyFilters();
            }
        }

        // Clear search
        function clearSearch() {
            document.getElementById('search-filter').value = '';
            document.getElementById('clear-search').classList.add('hidden');
            filterSales();
        }

        // Toggle advanced filters
        function toggleAdvancedFilters() {
            const filters = document.getElementById('advanced-filters');
            const icon = document.getElementById('filter-toggle-icon');
            
            if (filters.classList.contains('hidden')) {
                filters.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                filters.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
            
            updateActiveFiltersCount();
        }

        // Update active filters count
        function updateActiveFiltersCount() {
            let count = 0;
            const filters = [
                'start-date-filter', 'end-date-filter', 'payment-status-filter', 
                'payment-filter', 'min-amount-filter', 'max-amount-filter'
            ];
            
            filters.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element && element.value && element.value.trim() !== '') {
                    count++;
                }
            });
            
            const searchValue = document.getElementById('search-filter').value;
            if (searchValue && searchValue.trim() !== '') {
                count++;
            }
            
            document.getElementById('active-filters-count').textContent = count;
        }

        // Clear all filters
        function clearAllFilters() {
            // Clear all filter inputs
            document.getElementById('search-filter').value = '';
            document.getElementById('payment-status-filter').value = '';
            document.getElementById('payment-filter').value = '';
            document.getElementById('min-amount-filter').value = '';
            document.getElementById('max-amount-filter').value = '';
            
            // Reset to default dates (last 30 days)
            setDefaultDates();
            
            // Hide clear search button
            document.getElementById('clear-search').classList.add('hidden');
            
            // Apply filters
            applyFilters();
        }

        // Enhanced sorting
        function sortBy(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            updateSortIcons();
            applyFilters();
        }

        function handleSort() {
            const sortValue = document.getElementById('sort-select').value;
            const [field, direction] = sortValue.split('-');
            currentSort = { field, direction };
            updateSortIcons();
            applyFilters();
        }

        function updateSortIcons() {
            // Reset all sort icons
            document.querySelectorAll('[id^="sort-"]').forEach(icon => {
                icon.className = 'fas fa-sort ml-1 text-gray-400';
            });
            
            // Update current sort icon
            const currentIcon = document.getElementById(`sort-${currentSort.field}`);
            if (currentIcon) {
                if (currentSort.direction === 'asc') {
                    currentIcon.className = 'fas fa-sort-up ml-1 text-purple-600';
                } else {
                    currentIcon.className = 'fas fa-sort-down ml-1 text-purple-600';
                }
            }
        }

        // Table view toggle
        function setTableView(view) {
            currentView = view;
            
            // Update button states
            const compactBtn = document.getElementById('compact-view');
            const detailedBtn = document.getElementById('detailed-view');
            
            if (view === 'compact') {
                compactBtn.className = 'px-3 py-1 text-sm rounded-md transition-all duration-200 bg-white text-gray-900 shadow-sm';
                detailedBtn.className = 'px-3 py-1 text-sm rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900';
            } else {
                detailedBtn.className = 'px-3 py-1 text-sm rounded-md transition-all duration-200 bg-white text-gray-900 shadow-sm';
                compactBtn.className = 'px-3 py-1 text-sm rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900';
            }
            
            // Re-render table with new view
            const tbody = document.getElementById('sales-table-body');
            if (tbody.children.length > 0) {
                // Re-apply current data with new view
                applyFilters();
            }
        }

        // Show loading state
        function showLoading() {
            isLoading = true;
            document.getElementById('table-loading').classList.remove('hidden');
            document.getElementById('table-container').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
        }

        // Hide loading state
        function hideLoading() {
            isLoading = false;
            document.getElementById('table-loading').classList.add('hidden');
            document.getElementById('table-container').classList.remove('hidden');
        }

        // Show empty state
        function showEmptyState() {
            document.getElementById('table-container').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
        }


        // Payment management for credit sales
        let currentSaleId = null;
        
        function getStatusBadge(status) {
            const badges = {
                'paid': '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Paid</span>',
                'pending': '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>',
                'overdue': '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Overdue</span>'
            };
            return badges[status] || badges['pending'];
        }
        
        
        // Record Payment Modal Functions
        function showRecordPayment(saleId, amountDue) {
            currentSaleId = saleId;
            document.getElementById('payment-amount').max = amountDue;
            document.getElementById('payment-amount').value = amountDue;
            document.getElementById('record-payment-modal').classList.remove('hidden');
        }
        
        function closeRecordPayment() {
            currentSaleId = null;
            document.getElementById('record-payment-modal').classList.add('hidden');
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-notes').value = '';
        }
        
        async function submitPayment() {
            if (!currentSaleId) return;
            
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const paymentMethod = document.getElementById('payment-method-select').value;
            const notes = document.getElementById('payment-notes').value;
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }
            
            try {
                const response = await makeRequest(`${API_BASE}/pos/sales/${currentSaleId}/payment`, {
                    method: 'POST',
                    body: JSON.stringify({
                        amount: amount,
                        payment_method: paymentMethod,
                        notes: notes
                    })
                });
                
                if (response.ok) {
                    alert('Payment recorded successfully!');
                    closeRecordPayment();
                    applyFilters(); // Refresh the sales table
                } else {
                    const error = await response.json();
                    alert('Error recording payment: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error recording payment:', error);
                alert('Error recording payment. Please try again.');
            }
        }
        
        // Payment History Modal Functions
        async function showPaymentHistory(saleId) {
            try {
                const response = await makeRequest(`${API_BASE}/pos/sales/${saleId}/payments`);
                if (response.ok) {
                    const result = await response.json();
                    displayPaymentHistory(result.sale, result.payment_history || []);
                    document.getElementById('payment-history-modal').classList.remove('hidden');
                } else {
                    alert('Error loading payment history');
                }
            } catch (error) {
                console.error('Error loading payment history:', error);
                alert('Error loading payment history');
            }
        }
        
        function closePaymentHistory() {
            document.getElementById('payment-history-modal').classList.add('hidden');
        }
        
        function displayPaymentHistory(sale, payments) {
            const content = document.getElementById('payment-history-content');
            
            const html = `
                <div class="p-4 bg-gray-50 border-b">
                    <h4 class="font-medium text-gray-800">Sale: ${sale.sale_number}</h4>
                    <p class="text-sm text-gray-600">Customer: ${sale.customer_name || 'Walk-in'}</p>
                    <p class="text-sm text-gray-600">Total: Rp${sale.total} | Amount Due: Rp${sale.amount_due}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Date</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Amount</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Method</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Type</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.map(payment => `
                                <tr class="border-b border-gray-100">
                                    <td class="px-4 py-3 text-sm">${new Date(payment.created_at).toLocaleDateString()}</td>
                                    <td class="px-4 py-3 text-sm font-medium text-green-600">Rp${payment.amount}</td>
                                    <td class="px-4 py-3 text-sm">${payment.payment_method}</td>
                                    <td class="px-4 py-3 text-sm">${payment.payment_type}</td>
                                    <td class="px-4 py-3 text-sm">${payment.notes || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        // Update refresh function
        function refreshCurrentView() {
            refreshSales();
        }

        // View sale details function
        function viewSaleDetails(saleId) {
            // Create a simple modal to show sale details
            const modal = document.createElement('div');
            modal.id = 'sale-details-modal';
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-6 border w-11/12 max-w-4xl shadow-lg rounded-lg bg-white">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800">Sale Details</h3>
                        <button onclick="closeSaleDetails()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="sale-details-content" class="text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading sale details...
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load sale details
            loadSaleDetails(saleId);
        }

        function closeSaleDetails() {
            const modal = document.getElementById('sale-details-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function loadSaleDetails(saleId) {
            try {
                // Load both sale details and payment history in parallel
                const [saleResponse, paymentsResponse] = await Promise.all([
                    makeRequest(`${API_BASE}/pos/sales/${saleId}`),
                    makeRequest(`${API_BASE}/pos/sales/${saleId}/payments`)
                ]);
                
                if (saleResponse.ok) {
                    const sale = await saleResponse.json();
                    
                    // Get payment history if available
                    let paymentHistory = [];
                    if (paymentsResponse.ok) {
                        const paymentsData = await paymentsResponse.json();
                        paymentHistory = paymentsData.payments || [];
                    }
                    
                    displaySaleDetails(sale, paymentHistory);
                } else {
                    document.getElementById('sale-details-content').innerHTML = 
                        '<div class="text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading sale details</div>';
                }
            } catch (error) {
                console.error('Error loading sale details:', error);
                document.getElementById('sale-details-content').innerHTML = 
                    '<div class="text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading sale details</div>';
            }
        }

        function displaySaleDetails(sale, paymentHistory = []) {
            const content = document.getElementById('sale-details-content');
            const paymentStatus = determinePaymentStatus(sale);
            const statusBadge = getStatusBadge(paymentStatus);
            
            let itemsHtml = '';
            if (sale.items && sale.items.length > 0) {
                itemsHtml = sale.items.map(item => `
                    <tr class="border-b border-gray-100">
                        <td class="px-4 py-3 text-sm">${item.product ? item.product.name : 'Unknown Product'}</td>
                        <td class="px-4 py-3 text-sm text-center">${item.quantity}</td>
                        <td class="px-4 py-3 text-sm text-right">Rp${item.price}</td>
                        <td class="px-4 py-3 text-sm text-right font-medium">Rp${item.total}</td>
                    </tr>
                `).join('');
            } else {
                itemsHtml = '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">No items found</td></tr>';
            }
            
            // Build payment history HTML
            let paymentHistoryHtml = '';
            if (paymentHistory && paymentHistory.length > 0) {
                paymentHistoryHtml = paymentHistory.map(payment => `
                    <tr class="border-b border-gray-100">
                        <td class="px-4 py-3 text-sm">${formatDate(payment.created_at)}</td>
                        <td class="px-4 py-3 text-sm font-medium text-green-600">Rp${payment.amount}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                                <i class="fas fa-${getPaymentIcon(payment.payment_method)} mr-1"></i>
                                ${(payment.payment_method || 'cash').charAt(0).toUpperCase() + (payment.payment_method || 'cash').slice(1)}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium rounded-full ${payment.payment_type === 'downpayment' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                ${payment.payment_type === 'downpayment' ? 'Down Payment' : 'Payment'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">${payment.notes || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${payment.user ? payment.user.name : 'System'}</td>
                    </tr>
                `).join('');
            } else if (sale.payment_method === 'credit') {
                paymentHistoryHtml = '<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">No payment history found</td></tr>';
            } else {
                paymentHistoryHtml = '<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">Payment completed at time of sale</td></tr>';
            }
            
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-3">Sale Information</h4>
                        <div class="space-y-2 text-sm">
                            <div><span class="font-medium">Sale Number:</span> ${sale.sale_number || '#' + sale.id}</div>
                            <div><span class="font-medium">Customer:</span> ${sale.customer_name || 'Walk-in'}</div>
                            <div><span class="font-medium">Date:</span> ${formatDate(sale.created_at)}</div>
                            <div><span class="font-medium">Cashier:</span> ${sale.user ? sale.user.name : 'Unknown'}</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-3">Payment Information</h4>
                        <div class="space-y-2 text-sm">
                            <div><span class="font-medium">Payment Method:</span> ${(sale.payment_method || 'cash').charAt(0).toUpperCase() + (sale.payment_method || 'cash').slice(1)}</div>
                            <div><span class="font-medium">Payment Status:</span> ${statusBadge}</div>
                            <div><span class="font-medium">Subtotal:</span> Rp${sale.subtotal ? sale.subtotal : sale.total}</div>
                            <div><span class="font-medium">Tax:</span> Rp${(sale.tax || 0)}</div>
                            <div><span class="font-medium">Discount:</span> Rp${(sale.discount || 0)}</div>
                            <div class="font-medium text-lg"><span class="font-medium">Total:</span> <span class="text-green-600">Rp${sale.total}</span></div>
                            ${sale.payment_method === 'credit' ? `
                                <div><span class="font-medium">Amount Paid:</span> <span class="text-green-600">Rp${sale.amount_paid || 0}</span></div>
                                <div><span class="font-medium">Amount Due:</span> <span class="text-red-600">Rp${sale.amount_due || 0}</span></div>
                                ${sale.due_date ? `<div><span class="font-medium">Due Date:</span> ${formatDate(sale.due_date)}</div>` : ''}
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border overflow-hidden mb-6">
                    <div class="px-4 py-3 bg-gray-50 border-b">
                        <h4 class="font-medium text-gray-800">Items</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Product</th>
                                    <th class="px-4 py-2 text-center text-sm font-medium text-gray-600">Quantity</th>
                                    <th class="px-4 py-2 text-right text-sm font-medium text-gray-600">Price</th>
                                    <th class="px-4 py-2 text-right text-sm font-medium text-gray-600">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="px-4 py-3 bg-gray-50 border-b">
                        <h4 class="font-medium text-gray-800 flex items-center">
                            <i class="fas fa-history mr-2 text-gray-600"></i>
                            Payment History
                            ${paymentHistory.length > 0 ? `<span class="ml-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full">${paymentHistory.length}</span>` : ''}
                        </h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Date</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Amount</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Method</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Type</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Notes</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Recorded By</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${paymentHistoryHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        // Load sales summary data
        async function loadSalesSummary() {
            try {
                const startDate = document.getElementById('start-date-filter').value;
                const endDate = document.getElementById('end-date-filter').value;
                
                let url = `${API_BASE}/pos/sales/summary?`;
                if (startDate) url += `start_date=${startDate}&`;
                if (endDate) url += `end_date=${endDate}&`;
                
                const response = await makeRequest(url);
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('total-sales').textContent = `Rp${(data.total_sales || 0)}`;
                    document.getElementById('total-transactions').textContent = data.total_transactions || 0;
                    document.getElementById('pending-payments').textContent = `Rp${(data.pending_payments || 0)}`;
                    document.getElementById('overdue-payments').textContent = `Rp${(data.overdue_payments || 0)}`;
                }
            } catch (error) {
                console.error('Error loading sales summary:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set user name if available
            const userInfo = JSON.parse(localStorage.getItem('user') || '{}');
            if (userInfo.name) {
                document.getElementById('user-name').textContent = userInfo.name;
            }
            
            // Initialize burger menu
            initializeBurgerMenu();
            
            // Initialize keyboard shortcuts
            initializeKeyboardShortcuts();
            
            setDefaultDates();
            applyFilters(); // Load sales with default date filters
            loadSalesSummary(); // Load summary statistics
        });

        // Initialize keyboard shortcuts for better accessibility
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                // Ctrl+F or Cmd+F to focus search
                if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
                    event.preventDefault();
                    document.getElementById('search-filter').focus();
                }
                
                // Escape key to clear search
                if (event.key === 'Escape') {
                    const searchInput = document.getElementById('search-filter');
                    if (searchInput === document.activeElement) {
                        clearSearch();
                    }
                    
                    // Also close any open modals
                    const modals = document.querySelectorAll('.fixed.inset-0:not(.hidden)');
                    modals.forEach(modal => {
                        if (modal.id === 'record-payment-modal') closeRecordPayment();
                        if (modal.id === 'payment-history-modal') closePaymentHistory();
                        if (modal.id === 'sale-details-modal') closeSaleDetails();
                    });
                }
                
                // Ctrl+R or Cmd+R to refresh (override default to use our refresh)
                if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
                    event.preventDefault();
                    refreshCurrentView();
                }
                
                
                // Alt+F to toggle advanced filters
                if (event.altKey && event.key === 'f') {
                    event.preventDefault();
                    toggleAdvancedFilters();
                }
                
                // Alt+V to toggle table view
                if (event.altKey && event.key === 'v') {
                    event.preventDefault();
                    const newView = currentView === 'compact' ? 'detailed' : 'compact';
                    setTableView(newView);
                }
            });
        }
    </script>
</body>
</html>
